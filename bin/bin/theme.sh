#!/usr/bin/env bash

# Show help
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	echo "Usage: $(basename "$0") wallpaper accent
Change the desktop theme, using colors generated by pywal, and reload required elements.

wallpaper	Path to the wallpaper (eg, ~/pictures/wallpaper/wallpaper.jpeg)
accent		The Xresources colour to use as an accent (eg, color6)
"
	exit 0
fi

background="#2b303b"
theme="$HOME/.arc-theme"

wal -n -b "$background" --backend colorz -i "$1"
xrdb merge "$HOME"/.Xresources

# Store the new accent colour
accent=$(grep -oP "(?<=\*\.$2:)\s*(#[[:xdigit:]]{6})" "$HOME"/.Xresources | tr -d "[:space:]" | cut -c2-)
feh --bg-fill "$1"

# Store current theme
echo "$HOME/pictures/wallpapers/$(basename $1)" > "$HOME"/.cache/theme_wallpaper
echo "$2" > "$HOME"/.cache/theme_accent_name
echo "$accent" > "$HOME"/.cache/theme_accent_hex

# Hot reload Awesome
if [[ $(ps aux | grep '[a]wesome') ]]; then 
	awesome-client "awesome.emit_signal('hot_reload::xresources')"
	awesome-client "beautiful.accent = beautiful.colors[\"$2\"]"
	awesome-client "awesome.emit_signal('hot_reload::colors')"
fi

# Change rofi accent color
perl -p -i -e "s/(?<=accent:)\s*(#[[:xdigit:]]{6})/ #$accent/" ~/.config/rofi/accent.rasi

# Check if there is already a GTK theme for this accent colour
# Ask to create a new theme if not
# In both cases, then set the new theme
if [[ -d "$HOME"/.themes/Arc-Dark_"$accent" ]]; then
	change_gtk.sh --theme="Arc-Dark_$accent"
# Check graphical environment available (stops hanging on startup)
elif [[ $(ps aux | grep '[a]wesome') ]]; then
	printf "\n"	
	read -p "No GTK theme found for this wallpaper/accent combo. Generate one now? [y/N] " -n 1 -r -t 5
	if [[ ! $REPLY =~ ^[Yy]$ ]]; then
		:
	else
		# Arc theme build process
		# https://github.com/jnsh/arc-theme/blob/master/INSTALL.md
		printf "\n"
		cd "$theme"
		arc-color-change.sh -b="#$accent" -s="$theme"
		./autogen.sh --prefix="$theme"/build --disable-gnome-shell --disable-cinnamon --disable-light --disable-lighter --disable-darker --disable-metacity --disable-plank --disable-unity --disable-xfwm
		make ./install && \
		mv "$theme"/build/share/themes/Arc-Dark "$HOME"/.themes/Arc-Dark_"$accent" && \
		change_gtk.sh --theme=Arc-Dark_"$accent" && \
		echo "Done!"
	fi
fi

# Check if there is already an icon theme for this accent colour
# Ask to create a new theme if not
# In both cases, then set the new theme
if [[ -d "$HOME"/.icons/papirus_"$accent" ]]; then
	change_gtk.sh --icons="papirus_$accent"
# Check graphical environment available (stops hanging on startup)
elif [[ $(ps aux | grep '[a]wesome') ]]; then
	printf "\n"
	read -p "No icon theme found for this wallpaper/accent combo. Generate one now? [y/N] " -n 1 -r -t 5
	if [[ ! $REPLY =~ ^[Yy]$ ]]; then
		:
	else
		# Papirus/oomox build process
		printf "\n"
		export MENU_FG="bac3cf" # Fix symbolic action icons not getting coloured correctly
		/opt/oomox/plugins/icons_papirus/change_color.sh -o papirus_"$accent" -c "#$accent" && \
		change_gtk.sh --icons=papirus_"$accent" && \
		echo "Done!"
	fi
fi	
